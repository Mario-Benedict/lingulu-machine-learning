name: CD - Deploy to Google Cloud Run

on:
  # Only trigger after CI workflow completes successfully
  workflow_run:
    workflows: ["CI - Tests and Validation"]
    types:
      - completed
    branches:
      - main
  
  # Allow manual trigger
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: lingulu-ml-api
  REGION: asia-southeast1  # Singapore region (GPU support)
  REGISTRY: asia-southeast1-docker.pkg.dev
  # GPU Configuration - Set to 'true' to enable L4 GPU deployment
  ENABLE_GPU: true  # Recommended: true for best performance

jobs:
  # Check if CI was successful (only for workflow_run trigger)
  check-ci:
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    steps:
      - name: Check CI workflow result
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "âŒ CI workflow did not succeed. Deployment cancelled."
          echo "CI conclusion: ${{ github.event.workflow_run.conclusion }}"
          exit 1
      
      - name: CI passed
        run: |
          echo "âœ… CI workflow passed successfully"
          echo "Proceeding with deployment..."
  
  deploy:
    runs-on: ubuntu-latest
    needs: [check-ci]
    # Deploy if: CI check passed OR manual trigger
    if: |
      always() &&
      (needs.check-ci.result == 'success' || github.event_name == 'workflow_dispatch')
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Deployment Info
        run: |
          echo "ğŸš€ Starting Deployment to Google Cloud Run"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "Triggered by: CI workflow completion"
            echo "CI Status: ${{ github.event.workflow_run.conclusion }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Triggered by: Manual dispatch"
          fi
          echo "Project: ${{ env.PROJECT_ID }}"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "Region: ${{ env.REGION }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}
      
      - name: Build Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/lingulu/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/lingulu/${{ env.SERVICE_NAME }}:latest \
            -f Dockerfile \
            .
          echo "âœ… Docker image built successfully"
      
      - name: Push Docker image to Artifact Registry
        run: |
          echo "ğŸ“¤ Pushing Docker image to Artifact Registry..."
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/lingulu/${{ env.SERVICE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/lingulu/${{ env.SERVICE_NAME }}:latest
          echo "âœ… Docker image pushed successfully"
      
      - name: Deploy to Cloud Run
        run: |
          echo "ğŸš€ Deploying to Cloud Run..."
          
          if [ "${{ env.ENABLE_GPU }}" = "true" ]; then
            echo "âš¡ Deploying with L4 GPU (Recommended for best performance)"
            gcloud run deploy ${{ env.SERVICE_NAME }} \
              --image ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/lingulu/${{ env.SERVICE_NAME }}:${{ github.sha }} \
              --platform managed \
              --region ${{ env.REGION }} \
              --allow-unauthenticated \
              --gpu 1 \
              --gpu-type nvidia-l4 \
              --memory 8Gi \
              --cpu 4 \
              --timeout 300 \
              --concurrency 100 \
              --min-instances 0 \
              --max-instances 5 \
              --set-env-vars "FLASK_ENV=${{ secrets.FLASK_ENV }}" \
              --set-env-vars "FLASK_DEBUG=${{ secrets.FLASK_DEBUG }}" \
              --set-env-vars "MODEL_ID=${{ secrets.MODEL_ID }}" \
              --set-env-vars "SAMPLING_RATE=${{ secrets.SAMPLING_RATE }}" \
              --set-env-vars "MAX_AUDIO_LENGTH_SECONDS=${{ secrets.MAX_AUDIO_LENGTH_SECONDS }}" \
              --set-env-vars "MAX_FILE_SIZE_MB=${{ secrets.MAX_FILE_SIZE_MB }}" \
              --set-env-vars "LOG_LEVEL=${{ secrets.LOG_LEVEL }}" \
              --set-env-vars "CUDA_VISIBLE_DEVICES=0" \
              --set-env-vars "NVIDIA_VISIBLE_DEVICES=all" \
              --set-env-vars "NVIDIA_DRIVER_CAPABILITIES=compute,utility" \
              --set-env-vars "OMP_NUM_THREADS=4" \
              --set-env-vars "MKL_NUM_THREADS=4" \
              --set-env-vars "DISABLE_TORCH_COMPILE=1" \
              --set-env-vars "HF_HUB_DISABLE_IMPLICIT_TOKEN=1"
            echo "âœ… Deployed with L4 GPU - Expected latency: ~150ms"
          else
            echo "âš ï¸  Deploying with CPU only (slower performance)"
            gcloud run deploy ${{ env.SERVICE_NAME }} \
              --image ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/lingulu/${{ env.SERVICE_NAME }}:${{ github.sha }} \
              --platform managed \
              --region ${{ env.REGION }} \
              --allow-unauthenticated \
              --memory 4Gi \
              --cpu 2 \
              --timeout 300 \
              --concurrency 80 \
              --min-instances 0 \
              --max-instances 10 \
              --set-env-vars "FLASK_ENV=${{ secrets.FLASK_ENV }}" \
              --set-env-vars "FLASK_DEBUG=${{ secrets.FLASK_DEBUG }}" \
              --set-env-vars "MODEL_ID=${{ secrets.MODEL_ID }}" \
              --set-env-vars "SAMPLING_RATE=${{ secrets.SAMPLING_RATE }}" \
              --set-env-vars "MAX_AUDIO_LENGTH_SECONDS=${{ secrets.MAX_AUDIO_LENGTH_SECONDS }}" \
              --set-env-vars "MAX_FILE_SIZE_MB=${{ secrets.MAX_FILE_SIZE_MB }}" \
              --set-env-vars "LOG_LEVEL=${{ secrets.LOG_LEVEL }}" \
              --set-env-vars "OMP_NUM_THREADS=4" \
              --set-env-vars "MKL_NUM_THREADS=4" \
              --set-env-vars "DISABLE_TORCH_COMPILE=1" \
              --set-env-vars "HF_HUB_DISABLE_IMPLICIT_TOKEN=1"
            echo "âš ï¸  Deployed with CPU only - Expected latency: ~800ms"
          fi
          
          echo "âœ… Deployment to Cloud Run completed"
      
      - name: Get Service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service URL: $SERVICE_URL"
      
      - name: Verify deployment
        run: |
          echo ""
          echo "ğŸ” Verifying deployment..."
          
          SERVICE_URL="${{ steps.get-url.outputs.SERVICE_URL }}"
          
          # Wait for service to be ready
          echo "  - Waiting for service to be ready..."
          sleep 10
          
          # Check health endpoint
          echo "  - Checking health endpoint..."
          HEALTH_URL="$SERVICE_URL/api/model/health"
          
          for i in {1..5}; do
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "    âœ“ Health check passed!"
              break
            else
              echo "    Attempt $i/5 failed, waiting..."
              sleep 5
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Service URL:    $SERVICE_URL"
          echo "ğŸ“ˆ Health Check:   $SERVICE_URL/api/model/health"
          echo "ğŸ“Š Metrics:        $SERVICE_URL/api/metrics"
          echo "ğŸ“ Predict API:    $SERVICE_URL/api/model/predict"
          echo "ğŸ–¼ï¸  Image:          ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/lingulu/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "ğŸ“ Region:         ${{ env.REGION }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Deployment workflow completed successfully!"
